#!/bin/bash
#Program: 
# This program is used to install cuckoo 

# Reference site:
# https://cuckoo.sh/docs/installation/host/installation.html
# https://stackoverflow.com/questions/41407396/is-gui-for-android-sdk-manager-gone
# https://github.com/idanr1986/cuckoo-droid/blob/master/README.md
# 

# First Clone our repository
# git clone https://github.com/crystalwwj/AndroidMalware.git






cd ~/android-sdk-linux/tools/
echo yes | sudo pip install pymongo==2.7.2
./emulator -avd aosx -writable-system -qemu -nand system,size=0x1f400000,file=/home/vb/.android/avd/aosx.avd/system-qemu.img&
# ./emulator -avd aosx -qemu -nand -system,size=0x1f400000,file="/home/vb/android-sdk-linux/system-images/android-16/default/armeabi-v7a/system.img"&
cd cuckoo/utils/android_emulator_creator/
sudo pip install adb
sudo apt-get install adb -y
bash create_guest_avd.sh
cd ~/cuckoo/agent/android/java_agent/
adb install CuckooAgent.apk

#### Manual Setting #####

cp ~/.android/avd/aosx.avd/system-qemu.img ~/android-sdk-linux/system-images/android-16/default/armeabi-v7a/system.img

### replace ~/cuckoo/analyzer/android/lib/api/adb.py with our adb.py
cd ~/cuckoo/analyzer/android/lib/api/
rm adb.py
cp ~/AndroidMalware/adb.py ~/cuckoo/analyzer/android/lib/api/


cd ~
wget https://github.com/androguard/androguard/archive/v2.0.tar.gz
tar -xvf v2.0.tar.gz
cd androguard-2.0/
sudo python setup.py install

# update pip 
sudo apt remove -y python-pip 
sudo pip install protobuf
sudo pip install requests
sudo pip install django==1.9.6
sudo pip install Jinja2==2.7.2
sudo apt-get install python-dpkt -y


# next --> hand on install Android 4.1.2
# See https://cuckoo-droid.readthedocs.io/en/latest/installation/guest_android_avd/requirements/

# Need to be modified~~~ (path of tools/ path of build-tools/xx.x.x / platform-tools)
# export PATH=$PATH:/home/vb/android-sdk-linux/tools:/home/vb/android-sdk-linux/build-tools/28.0.3:/home/vb/android-sdk-linux/platform-tools


sudo apt-get install lib64stdc++6:i386
cd ~/android-sdk-linux/tools/lib64/libstdc++
mv libstdc++.so.6 libstdc++.so.6.bak
ln -s /usr/lib64/libstdc++.so.6 ~/android-sdk-linux/tools/lib64/libstdc++

## Warning !!!! GPU option-> DONT click !!! 

## Modify create_guest_avd.sh
## $ADB push ../../agent/android/python_agent/* /data/local/
## if you still get installation problems, try: export path again 
## e.g. export PATH=$PATH:/home/vb/Downloads/android-sdk-linux/platform-tools
export PATH=$PATH:/home/vb/Downloads/android-sdk-linux/platform-tools
bash create_guest_avd.sh
sudo apt-get install adb -y

cd ~/cuckoo/agent/android/java_agent/
adb install CuckooAgent.apk


## sudo apt install adb --> no need if u export path correctly

sudo apt-get google-cloud
sudo pip install protobuf

## the path in config avd... cannot annotate after the variable

emulator -avd aosx -qemu -nand -system,size=0x1f400000,file=/home/vb/Downloads/android-sdk-linux/system-images/android-16/default/armeabi-v7a/system.img



# Download mitmproxy manually


# install virtualbox 
# Note need to install vb extension pack
#echo deb http://download.virtualbox.org/virtualbox/debian xenial contrib | sudo #tee -a /etc/apt/sources.list.d/virtualbox.list
#wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-#key add -
#sudo apt-get -y update
#sudo apt-get -y install virtualbox-5.2



#?sudo groupadd pcap
#?sudo usermod -a -G pcap cuckoo
#?sudo chgrp pcap /usr/sbin/tcpdump


# (Optional) install volatility

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

# Installing guacd
sudo apt -y install libguac-client-rdp0 libguac-client-vnc0 libguac-client-ssh0 guacd
#sudo apt -y install libcairo2-dev libjpeg-turbo8-dev libpng-dev libossp-uuid-dev libfreerdp-dev
#mkdir /tmp/guac-build && cd /tmp/guac-build
#wget https://www.apache.org/dist/guacamole/0.9.14/source/guacamole-server-0.9.14.tar.gz
#tar xvf guacamole-server-0.9.14.tar.gz && cd guacamole-server-0.9.14
#./configure --with-init-dir=/etc/init.d
#make && sudo make install && cd ..
#sudo ldconfig
#sudo /etc/init.d/guacd start

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
# 
sudo apt -y update
#sudo python -m pip install -U pip==8.0.1
#(sudo apt -y install python-pip)
#sudo apt -y install python3-pip

# Optional add user
#sudo adduser cuckoo
# For the one choosing the virtualbox path
#sudo usermod -a -G vboxusers cuckoo
#sudo usermod -a -G libvirtd cuckoo

# install cuckoo (Globally)
sudo -H pip install -U pip setuptools
sudo -H pip install -U cuckoo

# From cuckoo droid readme

git config --global user.email "b02901043@ntu.edu.tw"
git config --global user.name "Nmlab137_malware"
git clone --depth=1 https://github.com/cuckoobox/cuckoo.git cuckoo -b 1.2
cd cuckoo
git remote add droid https://github.com/idanr1986/cuckoo-droid

# have bugs
#git pull --allow-unrelated-histories --no-edit -s recursive -X theirs droid master 
git pull --no-edit -s recursive -X theirs droid master 
cat conf-extra/processing.conf >> conf/processing.conf
cat conf-extra/reporting.conf >> conf/reporting.conf
rm -r conf-extra
echo "protobuf" >> requirements.txt

# install openjdk -- Warning!!!!!! Security issue exists
# May need to download for a long time...zzz
sudo add-apt-repository ppa:openjdk-r/ppa  
sudo apt-get update   
sudo apt-get -y install openjdk-7-jdk  




