#!/bin/bash
#Program: 
# This program is used to install cuckoo 

# Reference site:
# https://cuckoo.sh/docs/installation/host/installation.html
# https://stackoverflow.com/questions/41407396/is-gui-for-android-sdk-manager-gone
# https://github.com/idanr1986/cuckoo-droid/blob/master/README.md
# 

# (Optional)
sudo apt -y install git
sudo apt -y install snap
sudo snap install vscode --classic
sudo apt -y install vim

# Download dependencies
sudo apt-get -y install python python-pip python-dev libffi-dev libssl-dev
sudo apt-get -y install python-virtualenv python-setuptools
sudo apt-get -y install libjpeg-dev zlib1g-dev swig
sudo apt-get -y install mongodb
sudo apt-get -y install postgresql libpq-dev

# (Optional) Install Yara
sudo apt-get -y update
sudo apt-get -y install libfuzzy-dev
# (Optional) Install Pydeep
#git clone https://github.com/kbandla/pydeep.git

# install KVM
sudo apt-get -y install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils python-libvirt
#sudo pip install XenAPI

# Download mitmproxy manually


# install virtualbox 
# Note need to install vb extension pack
#echo deb http://download.virtualbox.org/virtualbox/debian xenial contrib | sudo #tee -a /etc/apt/sources.list.d/virtualbox.list
#wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-#key add -
#sudo apt-get -y update
#sudo apt-get -y install virtualbox-5.2

# install tcpdump
sudo apt-get -y install tcpdump apparmor-utils
sudo aa-disable /usr/sbin/tcpdump

#?sudo groupadd pcap
#?sudo usermod -a -G pcap cuckoo
#?sudo chgrp pcap /usr/sbin/tcpdump

sudo setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump
getcap /usr/sbin/tcpdump
sudo apt-get -y install libcap2-bin

# (Optional) install volatility

# install M2Crypto
sudo apt-get -y install swig
sudo -H pip install m2crypto==0.24.0

# Installing guacd
sudo apt -y install libguac-client-rdp0 libguac-client-vnc0 libguac-client-ssh0 guacd
#sudo apt -y install libcairo2-dev libjpeg-turbo8-dev libpng-dev libossp-uuid-dev libfreerdp-dev
#mkdir /tmp/guac-build && cd /tmp/guac-build
#wget https://www.apache.org/dist/guacamole/0.9.14/source/guacamole-server-0.9.14.tar.gz
#tar xvf guacamole-server-0.9.14.tar.gz && cd guacamole-server-0.9.14
#./configure --with-init-dir=/etc/init.d
#make && sudo make install && cd ..
#sudo ldconfig
#sudo /etc/init.d/guacd start

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
# 
sudo apt -y update
#sudo python -m pip install -U pip==8.0.1
#(sudo apt -y install python-pip)
#sudo apt -y install python3-pip

# Optional add user
#sudo adduser cuckoo
# For the one choosing the virtualbox path
#sudo usermod -a -G vboxusers cuckoo
#sudo usermod -a -G libvirtd cuckoo

# install cuckoo (Globally)
sudo -H pip install -U pip setuptools
sudo -H pip install -U cuckoo

# From cuckoo droid readme

git config --global user.email "b02901043@ntu.edu.tw"
git config --global user.name "Nmlab137_malware"
git clone --depth=1 https://github.com/cuckoobox/cuckoo.git cuckoo -b 1.2
cd cuckoo
git remote add droid https://github.com/idanr1986/cuckoo-droid

# have bugs
#git pull --allow-unrelated-histories --no-edit -s recursive -X theirs droid master 
git pull --no-edit -s recursive -X theirs droid master 
cat conf-extra/processing.conf >> conf/processing.conf
cat conf-extra/reporting.conf >> conf/reporting.conf
rm -r conf-extra
echo "protobuf" >> requirements.txt

# install dependency for cuckoo droid
sudo apt-get -y install libstdc++6:i386 libgcc1:i386 zlib1g:i386 libncurses5:i386
# install openjdk -- Warning!!!!!! Security issue exists
# May need to download for a long time...zzz
sudo add-apt-repository ppa:openjdk-r/ppa  
sudo apt-get update   
sudo apt-get -y install openjdk-7-jdk  

# download android sdk
wget dl.google.com/android/android-sdk_r24.4.1-linux.tgz
tar -xvzf android-sdk_r24.4.1-linux.tgz
cd android-sdk
tools/android

# next --> hand on install Android 4.1.2
# See https://cuckoo-droid.readthedocs.io/en/latest/installation/guest_android_avd/requirements/

# Need to be modified~~~ (path of tools/ path of build-tools/xx.x.x / platform-tools)
export PATH=$PATH:/home/vb/android-sdk-linux/tools:/home/vb/android-sdk-linux/build-tools/28.0.3:/home/vb/android-sdk-linux/platform-tools


sudo apt-get install lib64stdc++6:i386
cd ~/android-sdk-linux/tools/lib64/libstdc++
mv libstdc++.so.6 libstdc++.so.6.bak
ln -s /usr/lib64/libstdc++.so.6 ~/android-sdk-linux/tools/lib64/libstdc++

## Warning !!!! GPU option-> DONT click !!! 

## Modify create_guest_avd.sh
## $ADB push ../../agent/android/python_agent/* /data/local/
## if you still get installation problems, try: export path again 
## e.g. export PATH=$PATH:/home/vb/Downloads/android-sdk-linux/platform-tools
export PATH=$PATH:/home/vb/Downloads/android-sdk-linux/platform-tools
bash create_guest_avd.sh
## sudo apt install adb --> no need if u export path correctly

sudo apt-get google-cloud
sudo pip install protobuf

## the path in config avd... cannot annotate after the variable

emulator -avd aosx -qemu -nand -system,size=0x1f400000,file=/home/vb/Downloads/android-sdk-linux/system-images/android-16/default/armeabi-v7a/system.img




